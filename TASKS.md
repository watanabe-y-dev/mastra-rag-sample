# RAG + MCP サンプル実装タスク

## 進捗管理

### 全体進捗
- 完了: 32 / 83 タスク (38.6%)
- `███████████░░░░░░░░░░░░░░░░░` 38.6%

### フェーズ別進捗
- フェーズ 0: 11 / 11 `██████████` 100% ✅ 完了
- フェーズ 1: 13 / 13 `██████████` 100% ✅ 完了
- フェーズ 2: 8 / 8   `██████████` 100% ✅ 完了
- フェーズ 3: 0 / 8   `░░░░░░░░░░` 0%
- フェーズ 4: 0 / 9   `░░░░░░░░░░` 0%
- フェーズ 5: 0 / 11  `░░░░░░░░░░` 0%
- フェーズ 6: 0 / 5   `░░░░░░░░░░` 0%

---

## フェーズ 0: 環境セットアップ

### Docker & PostgreSQL
- [x] docker-compose.yml の作成
- [x] PostgreSQL + pgvector コンテナの起動
- [x] pgvector 拡張のインストール確認
- [x] .env ファイルの設定確認

### 依存関係のインストール
- [x] @modelcontextprotocol/sdk のインストール（MCP Server の実装）
- [x] @mastra/pg のインストール（PostgreSQL + pgvector ベクトルストア）
- [x] @ai-sdk/openai と ai のインストール（OpenAI API でテキストをベクトル化）
- [x] express と cors のインストール（HTTP Server と CORS 対応）
- [x] dotenv のインストール（環境変数管理）
- [x] zod のインストール（スキーマバリデーション）
- [x] TypeScript 型定義のインストール（@types/express, @types/cors, @types/node, typescript, tsx）

---

## フェーズ 1: RAG Core 実装

### ベクトルストアの初期化
- [x] PgVector インスタンスの作成
- [x] PostgreSQL への接続確認
- [x] ベクトルインデックスの作成
- [x] インデックス作成の冪等性確保

### 埋め込み生成の実装
- [x] OpenAI Embeddings API の設定
- [x] text-embedding-3-small モデルの使用
- [x] 埋め込み生成関数の実装
- [x] エラーハンドリング

### サンプルデータの追加
- [x] サンプルドキュメントの準備
- [x] ドキュメントをベクトル化
- [x] PostgreSQL へのアップサート
- [x] メタデータの保存
- [x] データ投入の確認

---

## フェーズ 2: RAG 検索機能の実装

### 検索関数の実装
- [x] クエリのベクトル化
- [x] ベクトル類似度検索の実行
- [x] topK パラメータの実装
- [x] メタデータ付き結果の取得
- [x] 結果の構造化

### エラーハンドリング
- [x] 検索結果が 0 件の場合の処理
- [x] ベクトルストア接続エラーの処理
- [x] タイムアウト処理

---

## フェーズ 3: HTTP Server + 認証の実装

### Express.js のセットアップ
- [ ] Express アプリケーションの作成
- [ ] JSON パーサーの設定
- [ ] CORS の設定
- [ ] ポート番号の環境変数化

### Bearer Token 認証の実装
- [ ] 認証ミドルウェアの作成
- [ ] Authorization ヘッダーのパース
- [ ] 環境変数 MCP_API_KEY との照合
- [ ] 認証失敗時の 401 レスポンス
- [ ] 認証成功時のログ出力

### エラーハンドリングミドルウェア
- [ ] グローバルエラーハンドラーの実装
- [ ] 適切なステータスコードの返却
- [ ] エラーログの出力

---

## フェーズ 4: MCP Server の実装

### MCP Server のセットアップ
- [ ] Server インスタンスの作成
- [ ] サーバー名とバージョンの設定
- [ ] SSE Transport の設定

### ツールの定義
- [ ] rag_search ツールの定義
- [ ] 入力スキーマの定義（Zod）
- [ ] 出力スキーマの定義

### ツールハンドラーの実装
- [ ] tools/list リクエストハンドラー
- [ ] tools/call リクエストハンドラー
- [ ] rag_search の実行ロジック
- [ ] クエリのバリデーション
- [ ] RAG 検索の実行
- [ ] 結果の JSON 化
- [ ] MCP レスポンスの構築

---

## フェーズ 5: 統合とテスト

### ローカルでの動作確認
- [ ] PostgreSQL コンテナの起動確認
- [ ] HTTP Server の起動確認
- [ ] /sse エンドポイントへのアクセス確認
- [ ] Bearer Token 認証のテスト
- [ ] rag_search ツールの動作確認

### Claude Desktop からの接続テスト
- [ ] claude_desktop_config.json の設定
- [ ] Claude Desktop の再起動
- [ ] MCP Server への接続確認
- [ ] rag_search ツールの実行テスト
- [ ] 検索結果の確認

### エラーケースのテスト
- [ ] 無効な API Key での接続試行
- [ ] 存在しないツールの呼び出し
- [ ] 不正な入力パラメータ
- [ ] PostgreSQL 停止時の挙動
- [ ] OpenAI API エラー時の挙動

---

## フェーズ 6: ドキュメント整備

### コードコメントの追加
- [ ] 主要な関数にコメント追加
- [ ] 型定義の説明追加
- [ ] 複雑なロジックの説明追加

### README の作成
- [ ] セットアップ手順の記載
- [ ] 環境変数の説明
- [ ] 起動方法の記載
- [ ] 動作確認方法の記載
- [ ] トラブルシューティングの記載

### サンプルクエリ集の作成
- [ ] 有効なクエリ例
- [ ] 期待される結果例
- [ ] エラーケース例

---

## 実装の優先順位

### 高優先度（MVP に必須）
- フェーズ 0: 環境セットアップ
- フェーズ 1: RAG Core 実装
- フェーズ 2: RAG 検索機能
- フェーズ 3: HTTP Server + 認証
- フェーズ 4: MCP Server 実装
- フェーズ 5: 基本的な動作確認

### 中優先度（品質向上）
- フェーズ 5: エラーケースのテスト
- フェーズ 6: ドキュメント整備

### 低優先度（あれば良い）
- オプション: 追加ツール
- オプション: パフォーマンス最適化
- オプション: セキュリティ強化

---

## 次のアクション

実装を開始する際は、以下の順序で進めること:

1. フェーズ 0 のタスクを全て完了
2. フェーズ 1 のタスクを順番に実装
3. 各フェーズ完了時に動作確認
4. 問題があれば記録して後で修正
